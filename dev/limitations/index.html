<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Limitations · OpenMDAO.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OpenMDAO.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../simple_paraboloid/">A Simple Example</a></li><li><a class="tocitem" href="../nonlinear_circuit/">A More Complicated Example</a></li><li><a class="tocitem" href="../shape_by_conn/">Variable Shapes at Runtime</a></li><li><a class="tocitem" href="../brachistochrone/">A Simple Dymos Example</a></li><li><a class="tocitem" href="../reference/">API Reference</a></li><li class="is-active"><a class="tocitem" href>Limitations</a><ul class="internal"><li><a class="tocitem" href="#Import-juliacall-first-from-Python...-sometimes"><span>Import <code>juliacall</code> first from Python... sometimes</span></a></li><li><a class="tocitem" href="#Dymos-ODEs-and-the-truthiness-of-Julia-callables-in-Python"><span>Dymos ODEs and the truthiness of Julia callables in Python</span></a></li></ul></li><li><a class="tocitem" href="../dev_docs/">Developer Docs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Limitations</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Limitations</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/byuflowlab/OpenMDAO.jl/blob/master/docs/src/limitations.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="Limitations"><a class="docs-heading-anchor" href="#Limitations">Limitations</a><a id="Limitations-1"></a><a class="docs-heading-anchor-permalink" href="#Limitations" title="Permalink"></a></h1><h2 id="Import-juliacall-first-from-Python...-sometimes"><a class="docs-heading-anchor" href="#Import-juliacall-first-from-Python...-sometimes">Import <code>juliacall</code> first from Python... sometimes</a><a id="Import-juliacall-first-from-Python...-sometimes-1"></a><a class="docs-heading-anchor-permalink" href="#Import-juliacall-first-from-Python...-sometimes" title="Permalink"></a></h2><p>When using the <code>omjlcomps</code> Python library, it is sometimes necessary to import <code>juliacall</code> before other Python libraries (at least <code>matplotlib</code>, maybe others too) to avoid an error that looks like this:</p><pre><code class="nohighlight hljs">$ cat test.py
import matplotlib
import juliacall
$ python test.py
ERROR: `ccall` requires the compilerTraceback (most recent call last):
  File &quot;/home/dingraha/desk/pythoncall_wtf/test.py&quot;, line 2, in &lt;module&gt;
    import juliacall
  File &quot;/home/dingraha/desk/pythoncall_wtf/venv-mybuild-with-libc-enable-shared-without-lto-without-optimizations-computed-gotos-no-dtrace-no-ssl/lib/python3.9/site-packages/juliacall/__init__.py&quot;, line 218, in &lt;module&gt;
    init()
  File &quot;/home/dingraha/desk/pythoncall_wtf/venv-mybuild-with-libc-enable-shared-without-lto-without-optimizations-computed-gotos-no-dtrace-no-ssl/lib/python3.9/site-packages/juliacall/__init__.py&quot;, line 214, in init
    raise Exception(&#39;PythonCall.jl did not start properly&#39;)
Exception: PythonCall.jl did not start properly
$</code></pre><p>This only occurs when using the <strong>system Python</strong> on certain Linux distributions (e.g., Python 3.9.7 on Red Hat Enterprise Linux 8.6). I&#39;ve found three workarounds:</p><ul><li>import the <code>juliacall</code> module first in your run script, before anything else, or</li><li>don&#39;t use the system Python: set up a Conda environment instead, or</li><li>don&#39;t use RHEL (the system Python on e.g. Arch Linux doesn&#39;t appear to suffer from this bug).</li></ul><p>See <a href="https://github.com/cjdoris/PythonCall.jl/issues/255">this PythonCall issue</a> for a few more details.</p><h2 id="Dymos-ODEs-and-the-truthiness-of-Julia-callables-in-Python"><a class="docs-heading-anchor" href="#Dymos-ODEs-and-the-truthiness-of-Julia-callables-in-Python">Dymos ODEs and the truthiness of Julia callables in Python</a><a id="Dymos-ODEs-and-the-truthiness-of-Julia-callables-in-Python-1"></a><a class="docs-heading-anchor-permalink" href="#Dymos-ODEs-and-the-truthiness-of-Julia-callables-in-Python" title="Permalink"></a></h2><p>To create a Dymos phase, the Dymos library requires the user to pass either a function or OpenMDAO <code>System</code> subclass that takes a <code>num_nodes</code> argument and return an OpenMDAO <code>System</code> that implements the ODE associated with the Dymos <code>Phase</code>. How do we do that with OpenMDAO.jl? It&#39;s easy enough to create, say, an <code>AbstractExplicitComp</code> that takes a <code>num_nodes</code> argument:</p><pre><code class="language-julia hljs">using OpenMDAOCore: OpenMDAOCore
struct FooODE &lt;: OpenMDAOCore.AbstractExplicitComp
    num_nodes::Int
    # made-up options:
    a::Float64
    b::Bool
end</code></pre><p>and then use <code>make_component</code> and a function to create a callable Julia function that fulfills Dymos&#39; requirements:</p><pre><code class="language-julia hljs">using OpenMDAO: om, make_component
a = 8.0
b = true
make_ode(num_nodes) = make_component(FooODE(num_nodes, a, b))
println(&quot;make_ode = $(make_ode), typeof(make_ode) = $(typeof(make_ode))&quot;)</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">make_ode = make_ode, typeof(make_ode) = typeof(Main.make_ode)</code></pre><p>But can we use that to construct a Dymos <code>Phase</code>?</p><pre><code class="language-julia hljs">using PythonCall: pyimport
dm = pyimport(&quot;dymos&quot;)
#
# Initialize the Problem and the optimization driver
#
p = om.Problem(model=om.Group())
p.driver = om.ScipyOptimizeDriver()
p.driver.declare_coloring()
#
# Create a trajectory and add a phase to it
#
traj = p.model.add_subsystem(&quot;traj&quot;, dm.Trajectory())
phase = traj.add_phase(&quot;phase0&quot;,
                       dm.Phase(ode_class = make_ode,
                                transcription = dm.GaussLobatto(num_segments=10)))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Python: &lt;dymos.phase.phase.Phase object at 0x7f44275088d0&gt;</code></pre><p>Yes! So we should be able to it in a trajectory optimization, right?</p><pre><code class="language-julia hljs">#
# Set the variables
#
phase.set_time_options(fix_initial=true, duration_bounds=(.5, 10))

phase.add_state(&quot;x&quot;, fix_initial=true, fix_final=true)

phase.add_state(&quot;y&quot;, fix_initial=true, fix_final=true)

phase.add_state(&quot;v&quot;, fix_initial=true, fix_final=false)

phase.add_control(&quot;theta&quot;, continuity=true, rate_continuity=true,
                  units=&quot;deg&quot;, lower=0.01, upper=179.9)

phase.add_parameter(&quot;g&quot;, units=&quot;m/s**2&quot;, val=9.80665)

#
# Minimize time at the end of the phase
#
phase.add_objective(&quot;time&quot;, loc=&quot;final&quot;, scaler=10)
#
p.model.linear_solver = om.DirectSolver()
#
# Setup the Problem
#
# p.setup() # Commented out to avoid error.
# This will throw something like:
#
# │   value =
# │    Python: TypeError: Julia: MethodError: no method matching length(::typeof(Main.__atexample__named__dymos_callable.make_ode))
# │    Closest candidates are:
# │      length(!Matched::Union{Base.KeySet, Base.ValueIterator}) at abstractdict.jl:58
# │      length(!Matched::Union{LinearAlgebra.Adjoint{T, S}, LinearAlgebra.Transpose{T, S}} where {T, S}) at ~/local/julia/1.8.5/share/julia/stdlib/v1.8/LinearAlgebra/src/adjtrans.jl:172
# │      length(!Matched::Union{Tables.AbstractColumns, Tables.AbstractRow}) at ~/.julia/packages/Tables/T7rHm/src/Tables.jl:180
# │      ...</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Python: &lt;openmdao.solvers.linear.direct.DirectSolver object at 0x7f44274b1750&gt;</code></pre><p>Nope, sad: the <code>Problem.setup()</code> call on the last line of that example throws an error. What&#39;s going wrong? I am not 100% clear on all the details, but what I think is happening is this:</p><ul><li><p>During the <code>Phase.setup</code> method, Dymos checks for the truthiness of the <code>ode_class</code> <code>Phase</code> <code>option</code>.</p></li><li><p>What is the truthiness of a class in Python? It depends:</p><ul><li>If the <code>__bool__</code> method is defined for the class, that result of calling that is used,</li><li>If <code>__bool__</code> isn&#39;t defined, then if <code>__len__</code> is defined, the result of calling that is used, with <code>0</code> considered <code>False</code> and any other value <code>True</code>,</li><li>If neither <code>__bool__</code> nor <code>__len__</code> are defined, then the class is considered <code>True</code>.</li></ul></li><li><p>The Julia function <code>make_ode</code> that we pass to the <code>Phase</code> constructor is converted to an <code>AnyValue</code> on the Python side by the Julia package PythonCall. The <code>AnyValue</code> class doesn&#39;t implement <code>__bool__</code>, but it <strong>does</strong> implement <code>__len__</code>, which calls the Julia function <code>length</code> on the Julia object.</p></li><li><p>But <code>length</code> doesn&#39;t have a method for plain old Julia functions, hence the error above.</p></li></ul><p>The workaround is to create a small <code>struct</code> called <a href="../reference/#OpenMDAO.DymosifiedCompWrapper"><code>DymosifiedCompWrapper</code></a> that takes an <code>OpenMDAOCore.AbstractComp</code> type (not instance) and all the non-<code>num_nodes</code> arguments, and implement a <code>Base.length</code> method for <code>DymosifiedCompWrapper</code> that always returns <code>1</code>, a truthy value in Python.</p><p>See the <a href="https://github.com/cjdoris/PythonCall.jl/issues/323">PythonCall issue on this topic</a> for news related to this topic.</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../reference/">« API Reference</a><a class="docs-footer-nextpage" href="../dev_docs/">Developer Docs »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.24 on <span class="colophon-date" title="Monday 12 June 2023 14:35">Monday 12 June 2023</span>. Using Julia version 1.9.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
