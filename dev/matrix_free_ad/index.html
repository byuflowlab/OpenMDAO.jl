<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>Auto-Matrix-Free Examples · OpenMDAO.jl</title><script data-outdated-warner src="../assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.045/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.13.24/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL=".."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="../assets/documenter.js"></script><script src="../siteinfo.js"></script><script src="../../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="../assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="../assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="../">OpenMDAO.jl</a></span></div><form class="docs-search" action="../search/"><input class="docs-search-query" id="documenter-search-query" name="q" type="text" placeholder="Search docs"/></form><ul class="docs-menu"><li><a class="tocitem" href="../">Home</a></li><li><a class="tocitem" href="../simple_paraboloid/">A Simple Example</a></li><li><a class="tocitem" href="../nonlinear_circuit/">A More Complicated Example</a></li><li><a class="tocitem" href="../shape_by_conn/">Variable Shapes at Runtime</a></li><li><a class="tocitem" href="../brachistochrone/">A Simple Dymos Example</a></li><li><a class="tocitem" href="../auto_dense_ad/">Auto-Dense Examples</a></li><li><a class="tocitem" href="../auto_sparse_ad/">Auto-Sparse Examples</a></li><li class="is-active"><a class="tocitem" href>Auto-Matrix-Free Examples</a><ul class="internal"><li><a class="tocitem" href="#The-User-Defined-Function-for-Matrix-Free-AD"><span>The User-Defined Function for Matrix-Free AD</span></a></li><li><a class="tocitem" href="#MatrixFreeADExplicitComp-Paraboloid"><span><code>MatrixFreeADExplicitComp</code> Paraboloid</span></a></li></ul></li><li><a class="tocitem" href="../creating_python_packages/">Creating Python Packages That Use OpenMDAOCore.jl</a></li><li><a class="tocitem" href="../reference/">API Reference</a></li><li><a class="tocitem" href="../limitations/">Limitations</a></li><li><a class="tocitem" href="../dev_docs/">Developer Docs</a></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><nav class="breadcrumb"><ul class="is-hidden-mobile"><li class="is-active"><a href>Auto-Matrix-Free Examples</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href>Auto-Matrix-Free Examples</a></li></ul></nav><div class="docs-right"><a class="docs-edit-link" href="https://github.com/byuflowlab/OpenMDAO.jl/blob/master/docs/src/matrix_free_ad.md" title="Edit on GitHub"><span class="docs-icon fab"></span><span class="docs-label is-hidden-touch">Edit on GitHub</span></a><a class="docs-settings-button fas fa-cog" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-sidebar-button fa fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a></div></header><article class="content" id="documenter-page"><h1 id="(Experimental)-Automatic-Matrix-Free-AD"><a class="docs-heading-anchor" href="#(Experimental)-Automatic-Matrix-Free-AD">(Experimental) Automatic Matrix-Free AD</a><a id="(Experimental)-Automatic-Matrix-Free-AD-1"></a><a class="docs-heading-anchor-permalink" href="#(Experimental)-Automatic-Matrix-Free-AD" title="Permalink"></a></h1><p>OpenMDAOCore.jl can create explicit components that are differentiated automatically by the AD packages supported by <a href="https://github.com/JuliaDiff/DifferentiationInterface.jl">DifferentiationInterface.jl</a> using Jacobian-vector or vector-Jacobian products instead of assembling the complete Jacobian. The resulting components will use the <a href="https://openmdao.org/newdocs/versions/latest/features/core_features/working_with_components/explicit_component.html?highlight=matrix%20free#the-matrix-free-api-providing-derivatives-as-a-matrix-vector-product">OpenMDAO Matrix-Free API</a>.</p><h2 id="The-User-Defined-Function-for-Matrix-Free-AD"><a class="docs-heading-anchor" href="#The-User-Defined-Function-for-Matrix-Free-AD">The User-Defined Function for Matrix-Free AD</a><a id="The-User-Defined-Function-for-Matrix-Free-AD-1"></a><a class="docs-heading-anchor-permalink" href="#The-User-Defined-Function-for-Matrix-Free-AD" title="Permalink"></a></h2><p>The requirements for the user-defined function for the matrix-free AD functionality is identical to those for <a href="../auto_dense_ad/#Automatic-Dense-AD">Automatic Dense AD</a> and <a href="../auto_sparse_ad/#Automatic-Sparse-AD">Automatic Sparse AD</a>, and the interface is much the same, as well. We&#39;ll still need to provide a function that expects a <code>ComponentVector</code> for its input, and either write its outputs to a <code>ComponentVector</code> (for the in-place form) or return a <code>ComponentVector</code> with outputs (for the out-of-place form). The only significant difference is that users will create a <code>MatrixFreeADExplicitComp</code> instead of a <code>SparseADExplicitComp</code>.</p><h2 id="MatrixFreeADExplicitComp-Paraboloid"><a class="docs-heading-anchor" href="#MatrixFreeADExplicitComp-Paraboloid"><code>MatrixFreeADExplicitComp</code> Paraboloid</a><a id="MatrixFreeADExplicitComp-Paraboloid-1"></a><a class="docs-heading-anchor-permalink" href="#MatrixFreeADExplicitComp-Paraboloid" title="Permalink"></a></h2><p>Let&#39;s do the good old Paraboloid example yet again, this time with the <code>MatrixFreeADExplicitComp</code>. We&#39;ll load the same packages as we did for the sparse AD example (except we don&#39;t need <code>SparseMatrixColorings</code> since we won&#39;t be doing sparsity):</p><pre><code class="language-julia hljs">using ADTypes: ADTypes
using ComponentArrays: ComponentVector
using OpenMDAOCore: OpenMDAOCore
using OpenMDAO: make_component</code></pre><p>We&#39;ll be using the same paraboloid function, but this time let&#39;s create an out-of-place function:</p><pre><code class="language-julia hljs">function f_paraboloid(X_ca, params)
    # Get the inputs:
    # Using @view with ReverseDiff.jl doesn&#39;t work for some reason.
    # x = @view(X_ca[:x])
    # y = @view(X_ca[:y])
    # Could also do this:
    x = X_ca.x
    y = X_ca.y
    # or even this
    # (; x, y) = X_ca

    # Do the calculation:
    f_xy = @. (x - 3.0)^2 + x*y + (y + 4.0)^2 - 3.0

    return ComponentVector(f_xy=f_xy)
end</code></pre><p>(For some reason the <code>@view</code> macro doesn&#39;t work with ReverseDiff.jl, the AD library we&#39;ll use for this example.)</p><p>Now we&#39;ll create the input <code>ComponentVector</code>. No need to create the output <code>ComponentVector</code> for the out-of-place callback function.</p><pre><code class="language-julia hljs">X_ca = ComponentVector(x=1.0, y=1.0)</code></pre><p>And finally we&#39;ll decide which AD library we&#39;ll use. For this one, let&#39;s try <a href="https://github.com/JuliaDiff/ReverseDiff.jl">ReverseDiff.jl</a>:</p><pre><code class="language-julia hljs">using ReverseDiff: ReverseDiff
ad_backend = ADTypes.AutoReverseDiff()</code></pre><p>Now we can create the component:</p><pre><code class="language-julia hljs">comp = OpenMDAOCore.MatrixFreeADExplicitComp(ad_backend, f_paraboloid, X_ca)
parab_comp = make_component(comp)</code></pre><p>As before, <code>make_component</code> will convert the <code>MatrixFreeADExplicitComp</code> into a OpenMDAO Python component that we can use with OpenMDAO. So now we just need to proceed with the paraboloid example as usual. But! We need to make sure to <a href="https://openmdao.org/newdocs/versions/latest/features/core_features/working_with_derivatives/picking_mode.html">tell OpenMDAO that we need to calculate total derivatives in reverse mode</a>, not forward, since we&#39;re using reverse AD for our paraboloid component. We do that by supplying the <code>mode=&quot;rev&quot;</code> argument to <code>Problem.setup()</code>.</p><pre><code class="language-julia hljs">using OpenMDAO: om

prob = om.Problem()

model = om.Group()
model.add_subsystem(&quot;parab_comp&quot;, parab_comp)

prob = om.Problem(model)

prob.driver = om.ScipyOptimizeDriver()
prob.driver.options[&quot;optimizer&quot;] = &quot;SLSQP&quot;

prob.model.add_design_var(&quot;parab_comp.x&quot;)
prob.model.add_design_var(&quot;parab_comp.y&quot;)
prob.model.add_objective(&quot;parab_comp.f_xy&quot;)

prob.setup(force_alloc_complex=true, mode=&quot;rev&quot;)

prob.set_val(&quot;parab_comp.x&quot;, 3.0)
prob.set_val(&quot;parab_comp.y&quot;, -4.0)

prob.run_model()
println(prob[&quot;parab_comp.f_xy&quot;])  # Should print `[-15.]`

prob.set_val(&quot;parab_comp.x&quot;, 5.0)
prob.set_val(&quot;parab_comp.y&quot;, -2.0)

prob.run_model()
println(prob.get_val(&quot;parab_comp.f_xy&quot;))  # Should print `[-5.]`</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">/home/runner/work/OpenMDAO.jl/OpenMDAO.jl/docs/.CondaPkg/.pixi/envs/default/lib/python3.14/site-packages/openmdao/visualization/n2_viewer/n2_viewer.py:115: OpenMDAOWarning:&#39;float&#39; object has no attribute &#39;shape&#39;
-15.0
-5.0</code></pre><p>Looks good. Let&#39;s check our derivatives using finite difference:</p><pre><code class="language-julia hljs">println(prob.check_partials(method=&quot;fd&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Warning: mode = &quot;fwd&quot; not supported for AD backend ADTypes.AutoReverseDiff(), preparation DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), derivatives for OpenMDAOCore.MatrixFreeADExplicitComp{false, ADTypes.AutoReverseDiff{false}, OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}, ComponentArrays.ComponentVector{ComplexF64, Vector{ComplexF64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, Dict{String, Nothing}}(ADTypes.AutoReverseDiff(), OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}(Main.f_paraboloid, nothing), (x = 5.0, y = -2.0), nothing, (x = 5.0e-324, y = 1.0e-323), (f_xy = 6.9107278880297e-310), &quot;&quot;, false, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), Dict{Symbol, String}(), Dict{Symbol, Vector{String}}(), Dict{Symbol, Bool}(), Dict{Symbol, Symbol}(), (x = 6.91071678141025e-310 + 6.9107948835431e-310im, y = 6.910728876976e-310 + 6.9107288769823e-310im), nothing, Dict{Symbol, String}(), Dict{Symbol, String}(), Dict{String, Nothing}()) will be incorrect
└ @ OpenMDAOCore ~/work/OpenMDAO.jl/OpenMDAO.jl/julia/OpenMDAOCore.jl/src/matrix_free_ad.jl:575
┌ Warning: mode = &quot;fwd&quot; not supported for AD backend ADTypes.AutoReverseDiff(), preparation DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), derivatives for OpenMDAOCore.MatrixFreeADExplicitComp{false, ADTypes.AutoReverseDiff{false}, OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}, ComponentArrays.ComponentVector{ComplexF64, Vector{ComplexF64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, Dict{String, Nothing}}(ADTypes.AutoReverseDiff(), OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}(Main.f_paraboloid, nothing), (x = 5.0, y = -2.0), nothing, (x = 5.0e-324, y = 1.0e-323), (f_xy = 6.9107278880297e-310), &quot;&quot;, false, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), Dict{Symbol, String}(), Dict{Symbol, Vector{String}}(), Dict{Symbol, Bool}(), Dict{Symbol, Symbol}(), (x = 6.91071678141025e-310 + 6.9107948835431e-310im, y = 6.910728876976e-310 + 6.9107288769823e-310im), nothing, Dict{Symbol, String}(), Dict{Symbol, String}(), Dict{String, Nothing}()) will be incorrect
└ @ OpenMDAOCore ~/work/OpenMDAO.jl/OpenMDAO.jl/julia/OpenMDAOCore.jl/src/matrix_free_ad.jl:575
{&#39;parab_comp&#39;: {(&#39;f_xy&#39;, &#39;x&#39;): {&#39;J_fwd&#39;: array([[0.]]), &#39;J_rev&#39;: array([[2.]]), &#39;J_fd&#39;: array([[2.000001]]), &#39;rows&#39;: None, &#39;cols&#39;: None, &#39;tol violation&#39;: _ErrorData(forward=1.9999990003674561, reverse=-9.99632543852158e-07, fwd_rev=1.999998), &#39;magnitude&#39;: _MagnitudeData(forward=0.0, reverse=2.0, fd=2.0000010003684565), &#39;vals_at_max_error&#39;: _ErrorData(forward=(np.float64(0.0), np.float64(2.0000010003684565)), reverse=(np.float64(2.0), np.float64(2.0000010003684565)), fwd_rev=(np.float64(0.0), np.float64(2.0))), &#39;abs error&#39;: _ErrorData(forward=2.0000010003684565, reverse=1.0003684565162985e-06, fwd_rev=2.0), &#39;rel error&#39;: _ErrorData(forward=1.0, reverse=5.001839780740122e-07, fwd_rev=1.0), &#39;matrix_free&#39;: True}, (&#39;f_xy&#39;, &#39;y&#39;): {&#39;J_fwd&#39;: array([[0.]]), &#39;J_rev&#39;: array([[9.]]), &#39;J_fd&#39;: array([[9.000001]]), &#39;rows&#39;: None, &#39;cols&#39;: None, &#39;tol violation&#39;: _ErrorData(forward=8.999992000457723, reverse=-7.999542276593274e-06, fwd_rev=8.999991), &#39;magnitude&#39;: _MagnitudeData(forward=0.0, reverse=9.0, fd=9.000001000458724), &#39;vals_at_max_error&#39;: _ErrorData(forward=(np.float64(0.0), np.float64(9.000001000458724)), reverse=(np.float64(9.0), np.float64(9.000001000458724)), fwd_rev=(np.float64(0.0), np.float64(9.0))), &#39;abs error&#39;: _ErrorData(forward=9.000001000458724, reverse=1.0004587238654494e-06, fwd_rev=9.0), &#39;rel error&#39;: _ErrorData(forward=1.0, reverse=1.1116206807248763e-07, fwd_rev=1.0), &#39;matrix_free&#39;: True}}}</code></pre><p>Now, some of the derivatives don&#39;t look so great! Why? There&#39;s a hint at the beginning of the output above in the form of a warning from OpenMDAOCore.jl. When checking the partial derivatives of a matrix-free component, OpenMDAO runs the component in both forward and reverse mode, showing the results in the output above as <code>Jfor</code> for forward, <code>Jrev</code> for reverse (and <code>Jfd</code> for the finite difference approximation to the derivatives). ReverseDiff.jl only supports reverse mode, however, so the derivatives calculated by our paraboloid component will be incorrect when run in forward mode (as the warning message tells us). Similarly, if we had chosen ForwardDiff.jl, the reverse-mode derivatives would have been incorrect. So, when looking at the output above, we need to ignore any result that involves <code>Jfor</code>, and just look at the comparisons between <code>Jrev</code> and <code>Jfd</code>. With that in mind, the derivatives look quite good.</p><p>We can also check the derivatives with the finite difference method:</p><pre><code class="language-julia hljs">println(prob.check_partials(method=&quot;cs&quot;))</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">┌ Warning: mode = &quot;fwd&quot; not supported for AD backend ADTypes.AutoReverseDiff(), preparation DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), derivatives for OpenMDAOCore.MatrixFreeADExplicitComp{false, ADTypes.AutoReverseDiff{false}, OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}, ComponentArrays.ComponentVector{ComplexF64, Vector{ComplexF64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, Dict{String, Nothing}}(ADTypes.AutoReverseDiff(), OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}(Main.f_paraboloid, nothing), (x = 5.0, y = -2.0), nothing, (x = 2.0, y = 9.0), (f_xy = 1.0), &quot;&quot;, false, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), Dict{Symbol, String}(), Dict{Symbol, Vector{String}}(), Dict{Symbol, Bool}(), Dict{Symbol, Symbol}(), (x = 6.91071678141025e-310 + 6.9107948835431e-310im, y = 6.910728876976e-310 + 6.9107288769823e-310im), nothing, Dict{Symbol, String}(), Dict{Symbol, String}(), Dict{String, Nothing}()) will be incorrect
└ @ OpenMDAOCore ~/work/OpenMDAO.jl/OpenMDAO.jl/julia/OpenMDAOCore.jl/src/matrix_free_ad.jl:575
┌ Warning: mode = &quot;fwd&quot; not supported for AD backend ADTypes.AutoReverseDiff(), preparation DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), derivatives for OpenMDAOCore.MatrixFreeADExplicitComp{false, ADTypes.AutoReverseDiff{false}, OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}, ComponentArrays.ComponentVector{ComplexF64, Vector{ComplexF64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Nothing, Dict{String, Nothing}}(ADTypes.AutoReverseDiff(), OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}(Main.f_paraboloid, nothing), (x = 5.0, y = -2.0), nothing, (x = 2.0, y = 9.0), (f_xy = 1.0), &quot;&quot;, false, DifferentiationInterface.NoPullbackPrep{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}(Val{Tuple{OpenMDAOCore.var&quot;#64#65&quot;{typeof(Main.f_paraboloid), Nothing}, ADTypes.AutoReverseDiff{false}, ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(x = 1, y = 2)}}}, Tuple{ComponentArrays.ComponentVector{Float64, Vector{Float64}, Tuple{ComponentArrays.Axis{(f_xy = 1,)}}}}, Tuple{}}}()), Dict{Symbol, String}(), Dict{Symbol, Vector{String}}(), Dict{Symbol, Bool}(), Dict{Symbol, Symbol}(), (x = 6.91071678141025e-310 + 6.9107948835431e-310im, y = 6.910728876976e-310 + 6.9107288769823e-310im), nothing, Dict{Symbol, String}(), Dict{Symbol, String}(), Dict{String, Nothing}()) will be incorrect
└ @ OpenMDAOCore ~/work/OpenMDAO.jl/OpenMDAO.jl/julia/OpenMDAOCore.jl/src/matrix_free_ad.jl:575
{&#39;parab_comp&#39;: {(&#39;f_xy&#39;, &#39;x&#39;): {&#39;J_fwd&#39;: array([[0.]]), &#39;J_rev&#39;: array([[2.]]), &#39;J_fd&#39;: array([[2.]]), &#39;rows&#39;: None, &#39;cols&#39;: None, &#39;tol violation&#39;: _ErrorData(forward=1.999998, reverse=-2e-06, fwd_rev=1.999998), &#39;magnitude&#39;: _MagnitudeData(forward=0.0, reverse=2.0, fd=2.0), &#39;vals_at_max_error&#39;: _ErrorData(forward=(np.float64(0.0), np.float64(2.0)), reverse=(np.float64(2.0), np.float64(2.0)), fwd_rev=(np.float64(0.0), np.float64(2.0))), &#39;abs error&#39;: _ErrorData(forward=2.0, reverse=0.0, fwd_rev=2.0), &#39;rel error&#39;: _ErrorData(forward=1.0, reverse=0.0, fwd_rev=1.0), &#39;matrix_free&#39;: True}, (&#39;f_xy&#39;, &#39;y&#39;): {&#39;J_fwd&#39;: array([[0.]]), &#39;J_rev&#39;: array([[9.]]), &#39;J_fd&#39;: array([[9.]]), &#39;rows&#39;: None, &#39;cols&#39;: None, &#39;tol violation&#39;: _ErrorData(forward=8.999991, reverse=-9e-06, fwd_rev=8.999991), &#39;magnitude&#39;: _MagnitudeData(forward=0.0, reverse=9.0, fd=9.0), &#39;vals_at_max_error&#39;: _ErrorData(forward=(np.float64(0.0), np.float64(9.0)), reverse=(np.float64(9.0), np.float64(9.0)), fwd_rev=(np.float64(0.0), np.float64(9.0))), &#39;abs error&#39;: _ErrorData(forward=9.0, reverse=0.0, fwd_rev=9.0), &#39;rel error&#39;: _ErrorData(forward=1.0, reverse=0.0, fwd_rev=1.0), &#39;matrix_free&#39;: True}}}</code></pre><p>Same story: the derivatives look good, assuming we just look at the comparisons between <code>Jrev</code> and <code>Jfd</code>. So we&#39;re ready to actually run the optimization to verify everything is working properly:</p><pre><code class="language-julia hljs">prob.run_driver()
println(&quot;f_xy = $(prob.get_val(&quot;parab_comp.f_xy&quot;))&quot;)  # Should print `[-27.33333333]`
println(&quot;x = $(prob.get_val(&quot;parab_comp.x&quot;))&quot;)  # Should print `[6.66666633]`
println(&quot;y = $(prob.get_val(&quot;parab_comp.y&quot;))&quot;)  # Should print `[-7.33333367]`</code></pre><pre class="documenter-example-output"><code class="nohighlight hljs ansi">Optimization terminated successfully    (Exit mode 0)
            Current function value: 18.016167304638333
            Iterations: 24
            Function evaluations: 24
            Gradient evaluations: 24
Optimization Complete
-----------------------------------
-----------------------------------------
Component: JuliaExplicitComp &#39;parab_comp&#39;
-----------------------------------------

  parab_comp: &#39;f_xy&#39; wrt &#39;x&#39;

    Max Tolerance Violation (Jfwd - Jfd) - (atol + rtol * Jfd) : 1.999999e+00 *
      abs error: 2.000001e+00
      rel error: 1.000000e+00
      fwd value @ max viol: 0.000000e+00
      fd value @ max viol: 2.000001e+00 (fd:forward)

    Max Tolerance Violation (Jrev - Jfd) - (atol + rtol * Jfd) : (-9.996325e-07)
      abs error: 1.000368e-06
      rel error: 5.001840e-07
      rev value @ max viol: 2.000000e+00
      fd value @ max viol: 2.000001e+00 (fd:forward)

    Max Tolerance Violation (Jrev - Jfwd) - (atol + rtol * Jfwd) : 1.999998e+00 *
      abs error: 2.000000e+00
      rel error: 1.000000e+00
      rev value @ max viol: 0.000000e+00
      fwd value @ max viol: 2.000000e+00

    Raw Forward Derivative (Jfwd)
    [[ 0.000000000000e+00]]

    Raw Reverse Derivative (Jrev)
    [[ 2.000000000000e+00]]

    Raw FD Derivative (Jfd)
    [[ 2.000001000368e+00]]

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  parab_comp: &#39;f_xy&#39; wrt &#39;y&#39;

    Max Tolerance Violation (Jfwd - Jfd) - (atol + rtol * Jfd) : 8.999992e+00 *
      abs error: 9.000001e+00
      rel error: 1.000000e+00
      fwd value @ max viol: 0.000000e+00
      fd value @ max viol: 9.000001e+00 (fd:forward)

    Max Tolerance Violation (Jrev - Jfd) - (atol + rtol * Jfd) : (-7.999542e-06)
      abs error: 1.000459e-06
      rel error: 1.111621e-07
      rev value @ max viol: 9.000000e+00
      fd value @ max viol: 9.000001e+00 (fd:forward)

    Max Tolerance Violation (Jrev - Jfwd) - (atol + rtol * Jfwd) : 8.999991e+00 *
      abs error: 9.000000e+00
      rel error: 1.000000e+00
      rev value @ max viol: 0.000000e+00
      fwd value @ max viol: 9.000000e+00

    Raw Forward Derivative (Jfwd)
    [[ 0.000000000000e+00]]

    Raw Reverse Derivative (Jrev)
    [[ 9.000000000000e+00]]

    Raw FD Derivative (Jfd)
    [[ 9.000001000459e+00]]

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

-----------------------------------------
Component: JuliaExplicitComp &#39;parab_comp&#39;
-----------------------------------------

  parab_comp: &#39;f_xy&#39; wrt &#39;x&#39;

    Max Tolerance Violation (Jfwd - Jfd) - (atol + rtol * Jfd) : 1.999998e+00 *
      abs error: 2.000000e+00
      rel error: 1.000000e+00
      fwd value @ max viol: 0.000000e+00
      fd value @ max viol: 2.000000e+00 (cs:None)

    Max Tolerance Violation (Jrev - Jfd) - (atol + rtol * Jfd) : (-2.000000e-06)
      abs error: 0.000000e+00
      rel error: 0.000000e+00
      rev value @ max viol: 2.000000e+00
      fd value @ max viol: 2.000000e+00 (cs:None)

    Max Tolerance Violation (Jrev - Jfwd) - (atol + rtol * Jfwd) : 1.999998e+00 *
      abs error: 2.000000e+00
      rel error: 1.000000e+00
      rev value @ max viol: 0.000000e+00
      fwd value @ max viol: 2.000000e+00

    Raw Forward Derivative (Jfwd)
    [[ 0.000000000000e+00]]

    Raw Reverse Derivative (Jrev)
    [[ 2.000000000000e+00]]

    Raw CS Derivative (Jfd)
    [[ 2.000000000000e+00]]

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

  parab_comp: &#39;f_xy&#39; wrt &#39;y&#39;

    Max Tolerance Violation (Jfwd - Jfd) - (atol + rtol * Jfd) : 8.999991e+00 *
      abs error: 9.000000e+00
      rel error: 1.000000e+00
      fwd value @ max viol: 0.000000e+00
      fd value @ max viol: 9.000000e+00 (cs:None)

    Max Tolerance Violation (Jrev - Jfd) - (atol + rtol * Jfd) : (-9.000000e-06)
      abs error: 0.000000e+00
      rel error: 0.000000e+00
      rev value @ max viol: 9.000000e+00
      fd value @ max viol: 9.000000e+00 (cs:None)

    Max Tolerance Violation (Jrev - Jfwd) - (atol + rtol * Jfwd) : 8.999991e+00 *
      abs error: 9.000000e+00
      rel error: 1.000000e+00
      rev value @ max viol: 0.000000e+00
      fwd value @ max viol: 9.000000e+00

    Raw Forward Derivative (Jfwd)
    [[ 0.000000000000e+00]]

    Raw Reverse Derivative (Jrev)
    [[ 9.000000000000e+00]]

    Raw CS Derivative (Jfd)
    [[ 9.000000000000e+00]]

 - - - - - - - - - - - - - - - - - - - - - - - - - - - - - -

f_xy = -27.333333333333336
x = [6.66666667]
y = [-7.33333333]</code></pre><p>We got the right answer, so everything&#39;s good!</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="../auto_sparse_ad/">« Auto-Sparse Examples</a><a class="docs-footer-nextpage" href="../creating_python_packages/">Creating Python Packages That Use OpenMDAOCore.jl »</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 0.27.25 on <span class="colophon-date" title="Monday 12 January 2026 13:52">Monday 12 January 2026</span>. Using Julia version 1.12.4.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
